rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Varsayılan olarak tüm okuma ve yazma işlemlerini reddet.
    match /{document=**} {
      allow read, write: if false;
    }

    // --- USERS ---
    // Herhangi bir kimliği doğrulanmış kullanıcının profilleri okumasına izin ver (arkadaş bulma vb. için).
    // Ancak bir kullanıcının yalnızca kendi belgesine yazmasına izin ver.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }

    // --- WATCHLISTS ---
    // Bir kullanıcı, belgedeki userId kendi kimliğiyle eşleşiyorsa bir izleme listesi oluşturabilir.
    // Yalnızca kendilerine ait olan listeleri okuyabilir, güncelleyebilir veya silebilirler.
    match /watchlists/{listId} {
      allow create: if request.auth.uid == request.resource.data.userId;
      allow read, update, delete: if request.auth.uid == resource.data.userId;
    }
    
    // --- RECOMMENDATIONS ---
    // Bir kullanıcı, fromUserId kendi kimliğiyle eşleşiyorsa bir tavsiye oluşturabilir.
    // Yalnızca alıcı (toUserId), tavsiyelerini okuyabilir veya silebilir.
    match /recommendations/{recommendationId} {
      allow create: if request.auth.uid == request.resource.data.fromUserId;
      allow read, delete: if request.auth.uid == resource.data.toUserId;
    }
    
    // --- FRIEND REQUESTS ---
    // Bir kullanıcı, fromUserId kendi kimliğiyle eşleşiyorsa bir istek oluşturabilir.
    // Bir kullanıcı, kendisine veya kendisinden gönderilen istekleri okuyabilir.
    // Alıcı, isteği güncelleyebilir (kabul edebilir) veya silebilir (reddedebilir).
    // Gönderen, isteği silebilir (iptal edebilir).
    match /friendRequests/{requestId} {
       allow create: if request.auth.uid == request.resource.data.fromUserId;
       allow read, delete: if request.auth.uid == resource.data.toUserId || request.auth.uid == resource.data.fromUserId;
       allow update: if request.auth.uid == resource.data.toUserId;
    }
  }
}
